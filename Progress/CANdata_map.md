# Link-level CO₂ Emission Visualization

CANデータを用いて，  
**道路リンク単位の CO₂ 排出量**を算出・可視化する．  

- **総排出量（kg / link）**
- **正規化排出強度（kg / veh-km）**

の 2 種類の指標を用いることで，  
「交通量が集中するリンク」と「1 台あたりの効率が悪いリンク」を区別して把握することを目的とする．

---

## 1. データ概要

- **入力データ**
  - 車両プローブデータ（parquet 形式）
    - CAN データ（燃料消費率）
    - GPS データ（map-matching 済み）
  - 道路ネットワークデータ（BLink）

- **対象期間**
  - 2023年9月1日〜2023年12月31日

- **データ規模**
  - 総レコード数：**2,770,043,364 行**
  - ユニーク車両台数：**90,893 台**
  - CO₂算出対象リンク数：**43,307 リンク**
  - BLink 総リンク数：86,953（うち CO₂ > 0 のリンク：41,558）

---

## 2. CO₂ 排出量の算出方法

### 2.1 燃料消費量の積分

 `fuelconsumption` は **L/h** と解釈し，  
車両ごとの時刻差 `dt`（秒）を用いて燃料消費量を積分する．

$$
\text{Fuel}_i [L] = \text{fuelconsumption}_i \times \frac{dt_i}{3600}
$$

- `dt` は VIN ごとに時系列で計算
- 異常値の影響を避けるため，`dt` は上限を設定してクリップ

---

### 2.2 CO₂ 換算

燃料消費量を以下の係数で CO₂ 排出量に変換する．

$$
\text{CO2}_i [kg] = \text{Fuel}_i \times 2.32
$$

- 換算係数：**2.32 kg-CO₂ / L（ガソリン換算）**

---

### 2.3 リンク単位への集計

リンク $a$ ごとに，以下を算出する：

- **総 CO₂ 排出量**

$$
CO2_a = \sum_{i \in a} CO2_i \quad [kg]
$$

- **通過車両台数**

$$
N_a = \text{unique VIN count}
$$

- **リンク長**
  - BLink の始点・終点座標からハーバサイン距離（km）

---

## 3. 可視化指標

本研究では，以下の 2 種類の指標を可視化する．

### 3.1 総 CO₂ 排出量（kg / link）

$$
CO2_a \quad [kg]
$$

- 期間全体で，当該リンクから排出された CO₂ の総量
- 交通量が集中する幹線道路が強調される

---

### 3.2 正規化 CO₂ 排出強度（kg / veh-km）

$$
\frac{CO2_a}{N_a \times L_a} \quad [kg / veh\text{-}km]
$$

- 台数と距離で正規化した指標
- 交通量の多寡に依存せず，
  - 渋滞
  - 信号密度
  - 勾配等
  により **効率が悪いリンク**を抽出可能

---

## 4. 可視化方法

- **リンク形状**
  - BLink の始点–終点を結ぶ直線
  - map-matching 点列由来の飛び線は発生しない

- **色分け**
  - CO₂ 指標に基づく連続カラースケール
  - 外れ値の影響を避けるため，分位（1–99%）で正規化

- **出力形式**
  - Folium による **スタンドアロン HTML**
  - Notebook や Python 環境を必要とせず，ブラウザのみで閲覧可能

---

## 5. 実行結果の例（上位リンク）

| link_id | CO₂ (kg/link) | CO₂ (kg/veh-km) | 台数 | 長さ (km) |
|---|---:|---:|---:|---:|
| 99741209 | 14,708 | 0.111 | 57,313 | 2.30 |
| 99683952 | 14,605 | 0.134 | 56,506 | 1.93 |
| 99687130 | 11,040 | 0.084 | 54,018 | 2.42 |

- **kg/link**：交通量が集中する主要リンクを反映  
- **kg/veh-km**：1 台あたりの排出効率の差を反映  

---

## 6. 出力ファイル


- `co2_per_link_all_days.html`  
  - 総 CO₂ 排出量（kg/link）

![6B5D00E2-FAB5-43B6-A780-644641955152_1_201_a](https://github.com/user-attachments/assets/fd3a0a80-a188-4632-9390-122de05e0c4d)

![1A4891A6-9415-4566-BDF8-0ADDE6CE1077_1_201_a](https://github.com/user-attachments/assets/cde41ac1-1ca7-41ff-afdf-42a13f056841)


- `co2_per_veh_km_all_days.html`  
  - 正規化 CO₂ 排出強度（kg/veh-km）

![68C0DD22-274A-49BA-B6AE-8381B38810B8_1_201_a](https://github.com/user-attachments/assets/61684c6f-a6af-4611-8576-005d594360f5)

![9C3E0EAC-8A59-407C-A25F-133E1BC7EADA_1_201_a](https://github.com/user-attachments/assets/7832a500-294a-4ae9-a8af-7d6606619cfc)
