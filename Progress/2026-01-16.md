# Sioux Falls ネットワークにおけるユーザー均衡配分（Frank–Wolfe 法）

## 概要
交通配分問題（Traffic Assignment Problem）における  
**ユーザー均衡（User Equilibrium, UE）配分**を、  
Frank–Wolfe（FW）法を用いて再現した。

ベンチマークとして、交通配分研究で広く用いられている  
**Sioux Falls ネットワーク**を対象とし、  
既知の最良解（SiouxFalls_flow.tntp）との比較により、
実装したアルゴリズムの妥当性を確認した。




## 使用データ
Sioux Falls データを使用した。

- ネットワークデータ：`SiouxFalls_net.csv`  
  （列：A, B, a0, a1, a2, a3, a4）
- OD 需要データ：`SiouxFalls_od.csv`  
  （列：O, D, Ton）
- 既知の最良解：`SiouxFalls_flow.tntp`  
  （From, To, Volume, Cost）



## モデル

### リンクコスト関数（BPR 型）
リンク $$l$$ の旅行時間（コスト）は、以下の多項式で表される。

$$
t_l(x_l) = a_0 + a_1 x_l + a_2 x_l^2 + a_3 x_l^3 + a_4 x_l^4
$$

Sioux Falls データでは  
$$a_1 = a_2 = a_3 = 0$$ であり、次の形となる。

$$
t_l(x_l) = a_0 + a_4 x_l^4
$$

これは、教科書的な BPR 関数

$$
t(x) = t^0 \left( 1 + 0.15 \left( \frac{x}{C} \right)^4 \right)
$$

を展開した形に対応している。



### ユーザー均衡（UE）
各利用者が自身の旅行時間を最小化するように経路を選択した結果、
いずれの利用経路もそれ以上短縮できない状態をユーザー均衡と定義する
（Wardrop の第1原則）。



## 解法：Frank–Wolfe 法

Frank–Wolfe 法では、以下の手順を反復する。

1. 現在のリンクコストに基づき、最短経路探索を行う
2. All-or-Nothing（AON）配分により補助解 $$y^k$$ を求める
3. 現在のフロー $$x^k$$ と補助解を凸結合して更新する

更新式は以下の通りである。

$$
x^{k+1} = (1-\alpha_k)x^k + \alpha_k y^k
$$

ステップサイズには、単純な減少ステップサイズを用いた。

$$
\alpha_k = \frac{1}{k+1}
$$



## 実装
- 最短経路探索：Dijkstra 法（NetworkX）
- 配分方法：All-or-Nothing 配分
- 解法：Frank–Wolfe 法

Notebook：
- `notebooks/01_ue_fw_clean.ipynb`


## 結果

Frank–Wolfe 法により得られた UE 配分結果を、
既知の最良解（SiouxFalls_flow.tntp）と比較した。

主要リンクにおける交通量および旅行時間の水準は概ね一致しており、
ネットワーク全体の流動構造および均衡特性は良好に再現されている。

一部リンクにおいて数値的な差が見られるが、
これは有限回反復および簡易的なステップサイズ設定による
近似解であることに起因するものである。

### 比較例（先頭リンク）
| From | To | 既知解 Volume | FW 解 Volume | 既知解 Cost | FW 解 Cost |
|---:|---:|---:|---:|---:|---:|
| 1 | 2 | 4494.66 | 4226.23 | 6.00082 | 6.00064 |
| 1 | 3 | 8119.08 | 7740.98 | 4.00869 | 4.00718 |
| 2 | 1 | 4519.08 | 4229.51 | 6.00083 | 6.00064 |



## 今後の課題
- 外部性（CO₂排出量、騒音、事故リスク等）を仮定したリンクコストの定義




## 実行環境
- Python
- pandas
- numpy
- networkx



---
# User Equilibrium Traffic Assignment on the Sioux Falls Network (Frank–Wolfe Method)

## Overview
In this study, the User Equilibrium (UE) traffic assignment problem is reproduced using the Frank–Wolfe (FW) method.
As a benchmark, the well-known Sioux Falls network, which is widely used in traffic assignment research, is adopted.
The validity of the implemented algorithm is verified by comparing the results with the known best solution (SiouxFalls_flow.tntp).

## Data
The following Sioux Falls datasets are used:
- Network data: `SiouxFalls_net.csv`  
(columns: A, B, a0, a1, a2, a3, a4)
- OD demand data: `SiouxFalls_od.csv`  
  (columns: O, D, Ton)
- Known best solution: `SiouxFalls_flow.tntp`  
  (From, To, Volume, Cost)

## Model

### Link Cost Function (BPR-type)
The travel time (cost) on link $$l$$ is represented by the following polynomial function:

$$
t_l(x_l) = a_0 + a_1 x_l + a_2 x_l^2 + a_3 x_l^3 + a_4 x_l^4
$$

In the Sioux Falls dataset,  
$$a_1 = a_2 = a_3 = 0$$ and the function simplifies to:

$$
t_l(x_l) = a_0 + a_4 x_l^4
$$

This formulation corresponds to the expanded form of the standard BPR function:

$$
t(x) = t^0 \left( 1 + 0.15 \left( \frac{x}{C} \right)^4 \right)
$$

### User Equilibrium (UE)
User Equilibrium is defined as the state in which all travelers choose routes that minimize their own travel times, and no traveler can unilaterally reduce their travel time by switching routes (Wardrop’s First Principle).

## Solution Method: Frank–Wolfe Algorithm

The Frank–Wolfe method iteratively performs the following steps:

1. Compute shortest paths based on the current link costs
2. Obtain an auxiliary solution $$y^k$$ via All-or-Nothing (AON) 
3. Update the current flow $$x^k$$ using a convex combination of the current and auxiliary solutions

The update rule is given by:

$$
x^{k+1} = (1-\alpha_k)x^k + \alpha_k y^k
$$

A simple diminishing step size is adopted:

$$
\alpha_k = \frac{1}{k+1}
$$

## Implementation
- Shortest path algorithm: Dijkstra (NetworkX)
- Assignment method: All-or-Nothing (AON)
- Solver: Frank–Wolfe method

Notebook：
- `notebooks/01_ue_fw_clean.ipynb`

## Results

The UE flow obtained using the Frank–Wolfe method is compared with the known best solution (SiouxFalls_flow.tntp).

For major links, both traffic volumes and travel times are generally consistent with the benchmark solution, indicating that the overall flow pattern and equilibrium characteristics of the network are well reproduced.

Although minor numerical differences are observed on some links, these discrepancies are attributable to the finite number of iterations and the use of a simplified step-size rule, which yields an approximate solution.

### Example Comparison (Selected Links)
| From | To | Known Volume | FW Volume | Known Cost | FW Cost |
|---:|---:|---:|---:|---:|---:|
| 1 | 2 | 4494.66 | 4226.23 | 6.00082 | 6.00064 |
| 1 | 3 | 8119.08 | 7740.98 | 4.00869 | 4.00718 |
| 2 | 1 | 4519.08 | 4229.51 | 6.00083 | 6.00064 |
