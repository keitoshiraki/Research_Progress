# SO(congestion)の配分結果（Sioux Falls）（混雑外部性のみ）

## 概要
**混雑外部性のみを考慮した System Optimum（SO）配分**を実装し、  
User Equilibrium（UE）との結果比較を行った。

- 対象ネットワーク：Sioux Falls  
- 配分方法：Logit-SUE（k-shortest paths + MSA）  
- SO の定義：**社会限界費用**に基づく配分  

SO におけるリンク一般化費用は以下で定義される。

$$
c_a^{SO}(x_a) = t_a(x_a) + x_a \frac{dt_a}{dx_a}
$$

BPR 関数は次式を用いた。

$$
t_a(x_a) = t_{0,a}\left(1 + \alpha \left(\frac{x_a}{c_a}\right)^\beta \right)
$$

> 本結果では、自由流時間および旅行時間の単位として **分（minute）** を用いている。


## 評価指標
本検証では、以下の指標を用いて UE と SO を比較した。

- **TotalFlow**  

$$
\sum_a x_a
$$

ネットワーク全体でのリンク通過回数の総和  
（OD 需要ではなく、リンク通過量の合計）

- **Total Travel Time (TTT)**

$$
\sum_a x_a \, t_a(x_a)
$$

（単位：veh・min）

- **Marginal Cost Total (TMC)**（SOで用いた限界費用の総和）

$$
\sum_a x_a \, c_a^{SO}(x_a)
$$

（単位：veh・min）

- **Congestion Externality (EXT)**（混雑外部性の総量）

$$
\sum_a x_a\left(c_a^{SO}(x_a)-t_a(x_a)\right)=
\sum_a x_a^2\frac{dt_a}{dx_a}
$$

（単位：veh・min）

- **Average Travel Time**

$$
\frac{\sum_a x_a \, t_a(x_a)}{\sum_a x_a}
$$

1 台あたりの平均旅行時間（単位：min）

- **Externality per Flow（外部性の平均）**

$$
\frac{\sum_a x_a\left(c_a^{SO}(x_a)-t_a(x_a)\right)}{\sum_a x_a}
$$

1 台あたりの混雑外部性（単位：min）



## UE と SO（混雑外部性）の比較結果（minute 単位）

| 指標 | UE | SO (congestion) | SO − UE | SO / UE |
|---|---:|---:|---:|---:|
| TotalFlow | 9.101×10⁵ | 9.427×10⁵ | +3.26×10⁴ | 1.036 |
| Total Travel Time (TTT) | 4.635×10⁶ | 4.642×10⁶ | +7.19×10³ | 1.002 |
| Total Marginal Cost (TMC) | 1.465×10⁷ | 1.433×10⁷ | −3.18×10⁵ | 0.978 |
| Congestion Externality (EXT) | 1.002×10⁷ | 9.693×10⁶ | −3.25×10⁵ | 0.968 |
| Average Travel Time | 5.09 | **4.92** | **−0.17** | **0.967** |
| EXT per TotalFlow | 11.01 | **10.28** | **−0.73** | **0.934** |



## 結果の解釈
- SO（混雑外部性）では、**限界費用に基づいて混雑の大きいリンクが相対的に回避**され、交通がネットワーク全体に分散した。  
- その結果：
  - リンク通過量の総和（TotalFlow）は増加
  - 総旅行時間（TTT）はほぼ変化しない
  - **平均旅行時間（1台あたり）は約 3% 短縮**（SO/UE = 0.967）
  - **混雑外部性（EXT）は約 3% 減少**（SO/UE = 0.968）
  - **1リンク1 台あたり外部性（EXT/TotalFlow）は約 7% 減少**（SO/UE = 0.934）

本研究では、**限界費用に基づく SO を確率的経路選択（Logit-SUE）として実装**している。  
そのため、厳密な総旅行時間最小化は保証されない一方で、  
混雑回避行動により **混雑外部性およびその平均が一貫して低下**することを確認した。


## 本結果の位置づけ
- 本結果は、今後導入する外部性  
  （CO₂排出量、事故リスク、騒音等）の **ベースライン**と位置づける。
- 次段階では、SO の一般化費用を以下のように拡張する。

$$
c_a =
t_a(x_a)+ x_a \frac{dt_a}{dx_a}+ \lambda_{CO_2} CO_{2,a}+ \lambda_{acc} Risk_a+ \lambda_{noise} Noise_a
$$

---

# SO(congestion+CO2)配分結果（Sioux Falls）

## 概要
これまでに，以下の 3 種類の配分結果を算出・比較した。

- **UE**：ユーザー均衡（私的旅行時間最小化）
- **SO (congestion)**：混雑外部性のみを内部化したシステム最適配分
- **SO (cong + CO₂)**：混雑外部性と CO₂ 外部性の両方を内部化したシステム最適配分

本検討の目的は，**混雑 SO に CO₂ 外部性を追加した際の追加的効果**を明らかにすることである。



## 配分手法
- 経路選択モデル：**Logit-SUE**
- 経路生成：*k*-shortest paths
- フロー更新：MSA（Method of Successive Averages）
- 対象ネットワーク：Sioux Falls
- リンクパフォーマンス関数：BPR 関数

BPR 関数は次式で与えられる。

$$
t_a(x_a) = t_{0,a}\left(1 + \alpha \left(\frac{x_a}{c_a}\right)^{\beta}\right)
$$



## システム最適（SO）の費用定義

### 混雑外部性のみを考慮した SO
混雑外部性のみを考慮する場合，リンク $a$ の社会的限界費用は

$$
c_a^{SO} = t_a(x_a) + x_a \frac{dt_a}{dx_a}
$$

と定義される。



### 混雑・CO₂外部性を考慮した SO
さらに CO₂ 外部性を内部化した場合，配分に用いる一般化費用は

$$
c_a = t_a(x_a) + x_a \frac{dt_a}{dx_a} + \lambda_{CO2} \cdot C^{CO2}_a
$$

と定義する。



## CO₂コストの算定（事後評価）

Sioux Falls では実走行データ（CAN データ）が存在しないため，
CO₂排出量は **配分結果を用いた事後評価（ex post）** として算定する。

### 速度
リンク $a$ における平均速度は

$$
v_a = \frac{60 L_a}{t_a}
$$

とする。  
ここで $L_a$ はリンク長（km）， $t_a$ は旅行時間（min）である。

### 排出係数
速度依存型 CO₂ 排出係数を

$$
EF(v) = A + Bv + Cv^2 \quad [\mathrm{g/km}]
$$

と定義する。

### CO₂コスト
リンク $a$ を 1 台の車両が通過する際の CO₂ コストは

$$
C^{CO2}_a = p_{CO2} \cdot \frac{EF(v_a) L_a}{1000}
\quad [\mathrm{yen/vehicle}]
$$

とする。

## パラメータ設定

本研究において，Sioux Falls ネットワークで用いた  
CO₂排出および費用評価に関するパラメータを以下に示す。

### CO₂排出係数（速度依存）
速度 $v$（km/h）に依存する CO₂ 排出係数は，
以下の二次関数で近似した。

$$
EF(v) = A + Bv + Cv^2 \quad [\mathrm{g/km}]
$$

本検討では，文献に基づく代表的な速度–排出関係を参考に，
以下の係数を採用した。

| パラメータ | 値 | 単位 | 備考 |
|---|---:|---:|---|
| $A$ | 500.17 | g/km | 定数項 |
| $B$ | −7.85 | g/(km·(km/h)) | 一次項 |
| $C$ | 0.0480 | g/(km·(km/h)²) | 二次項 |



### CO₂価格
CO₂排出量を費用に換算するため，
炭素価格 $p_{CO2}$ を以下のように設定した。

| パラメータ | 値 | 単位 |
|---|---:|---:|
| $p_{CO2}$ | 15 | yen/kg-CO₂ |

本値は，国内外の社会的炭素価格の下限的水準を参考とした。



### 時間価値（Value of Time）
旅行時間を金銭換算するための時間価値（VOT）は，
以下の値を用いた。

| パラメータ | 値 | 単位 |
|---|---:|---:|
| VOT | 43.74 | yen/min |



## $\lambda$ の定義（単位整合）

SO(cong+CO₂) 配分では，
混雑に関する費用は「時間（min）」で評価される一方，
CO₂コストは「金銭（yen）」で算出される。

そこで，CO₂コストを時間単位に変換するため，
以下の係数 $\lambda_{CO2}$ を導入した。

$$
\lambda_{CO2} = \frac{1}{\mathrm{VOT}}
$$

これにより，一般化費用はすべて時間単位で統一され，
SO(cong+CO₂) におけるリンク一般化費用は

$$
c_a
= t_a(x_a)+ x_a \frac{dt_a}{dx_a}+ \lambda_{CO2} \cdot C^{CO2}_a
$$

と定義される。


## 配分結果の比較

### コスト内訳（総量）

| コスト項目 | 総量 | 単位 |
|---|---:|---:|
| 私的旅行時間 $\sum x_a t_a$ | 4,622,983 | veh·min |
| 混雑外部性 $\sum x_a^2 \frac{dt_a}{dx_a}$ | 9,638,484 | veh·min |
| CO₂外部性 $\sum \lambda_{CO2} C^{CO2}_a$ | 291,043 | veh·min |

以下の表は，**SO (cong + CO₂)** を基準として，
- UE からの改善効果
- SO (congestion) に CO₂ 外部性を追加した純効果

を同時に比較したものである。

| 指標 | UE | SO (congestion) | SO (cong+CO₂) | Δ(SO+CO₂ − UE) | SO+CO₂ / UE | Δ(SO+CO₂ − SO) | SO+CO₂ / SO |
|---|---:|---:|---:|---:|---:|---:|---:|
| Total Flow | 9.10×10⁵ | 9.43×10⁵ | 9.41×10⁵ | +3.06×10⁴ | 1.034 | −2.00×10³ | 0.998 |
| Total Travel Time (TTT) | 4.63×10⁶ | 4.64×10⁶ | 4.62×10⁶ | −1.15×10⁴ | 0.998 | −1.87×10⁴ | 0.996 |
| Total Marginal Cost (TMC) | 1.47×10⁷ | 1.43×10⁷ | 1.43×10⁷ | −3.91×10⁵ | 0.973 | −7.33×10⁴ | 0.995 |
| Congestion Externality (EXT) | 1.00×10⁷ | 9.69×10⁶ | 9.64×10⁶ | −3.80×10⁵ | 0.962 | −5.46×10⁴ | 0.994 |
| **平均旅行時間 (min)** | 5.09 | 4.92 | **4.91** | **−0.18** | **0.965** | **−0.01** | **0.998** |
| **1台あたり混雑外部性 (min)** | 11.01 | 10.28 | **10.25** | **−0.76** | **0.931** | **−0.04** | **0.996** |
| **CO₂総コスト (yen)** | 9.55×10⁶ | 9.83×10⁶ | **9.79×10⁶** | +2.46×10⁵ | 1.026 | **−3.30×10⁴** | **0.997** |
| **1台あたり CO₂コスト (yen)** | 10.49 | 10.42 | **10.41** | −0.08 | 0.992 | **−0.01** | **0.999** |



## 考察（現時点）
- 混雑外部性を内部化した SO 配分により，全体効率は大きく改善する。
- CO₂ 外部性を追加的に内部化することで，**混雑効率をほぼ維持したまま CO₂ コストが削減**される。
- CO₂ 削減効果は小さいが，一貫して減少方向に作用している。

Sioux Falls は小規模かつ単純化されたネットワークであり，
速度分布の幅が小さいため，
CO₂（速度依存）外部性の効果が限定的になると考えられる。

---

# SO (Congestion) Assignment Results (Sioux Falls)  
*(Congestion Externality Only)*

## Overview
In this section, a **System Optimum (SO) assignment considering only congestion externality** is implemented and compared with the **User Equilibrium (UE)** solution.

- **Network**: Sioux Falls  
- **Assignment method**: Logit-SUE (*k*-shortest paths + MSA)  
- **Definition of SO**: Based on **marginal social cost**

The generalized link cost under SO is defined as

$$
c_a^{SO}(x_a) = t_a(x_a) + x_a \frac{dt_a}{dx_a}
$$

where the link travel time follows the BPR function:

$$
t_a(x_a) = t_{0,a}\left(1 + \alpha \left(\frac{x_a}{c_a}\right)^\beta \right)
$$

> In this analysis, **minutes** are used as the unit of free-flow time and travel time.



## Evaluation Metrics

### Total Flow

$$
\sum_a x_a
$$

Total number of link traversals over the network  
(note that this is not OD demand but the sum of link flows)

### Total Travel Time (TTT)

$$
\sum_a x_a \, t_a(x_a)
$$

(Unit: veh·min)

### Total Marginal Cost (TMC)

$$
\sum_a x_a \, c_a^{SO}(x_a)
$$

(Unit: veh·min)

### Congestion Externality (EXT)

$$
\sum_a x_a\left(c_a^{SO}(x_a)-t_a(x_a)\right)
= \sum_a x_a^2\frac{dt_a}{dx_a}
$$

(Unit: veh·min)

### Average Travel Time

$$
\frac{\sum_a x_a \, t_a(x_a)}{\sum_a x_a}
$$

Average travel time per vehicle (min)

### Externality per Flow

$$
\frac{\sum_a x_a\left(c_a^{SO}(x_a)-t_a(x_a)\right)}{\sum_a x_a}
$$

Average congestion externality per vehicle (min)



## Comparison of UE and SO (Congestion Only)

| Indicator | UE | SO (congestion) | SO − UE | SO / UE |
|---|---:|---:|---:|---:|
| Total Flow | 9.101×10⁵ | 9.427×10⁵ | +3.26×10⁴ | 1.036 |
| Total Travel Time (TTT) | 4.635×10⁶ | 4.642×10⁶ | +7.19×10³ | 1.002 |
| Total Marginal Cost (TMC) | 1.465×10⁷ | 1.433×10⁷ | −3.18×10⁵ | 0.978 |
| Congestion Externality (EXT) | 1.002×10⁷ | 9.693×10⁶ | −3.25×10⁵ | 0.968 |
| Average Travel Time | 5.09 | **4.92** | **−0.17** | **0.967** |
| Externality per Flow | 11.01 | **10.28** | **−0.73** | **0.934** |



## Interpretation of Results
- Under SO (congestion), traffic is redistributed away from highly congested links based on marginal social cost.
- As a result:
  - Total link flow increases due to traffic dispersion
  - Total travel time remains almost unchanged
  - **Average travel time per vehicle decreases by about 3%** (SO/UE = 0.967)
  - **Total congestion externality decreases by about 3%** (SO/UE = 0.968)
  - **Average congestion externality per vehicle decreases by about 7%** (SO/UE = 0.934)

In this study, SO is implemented as a **stochastic assignment (Logit-SUE)** rather than a deterministic system-optimal solution.  
Therefore, strict minimization of total travel time is not guaranteed.  
Nevertheless, congestion avoidance behavior consistently reduces congestion externality and its average value.



## Positioning of This Result
- This result serves as a **baseline** for introducing additional externalities  
  (CO₂ emissions, accident risk, noise, etc.).
- In the next stage, the generalized cost for SO will be extended as follows:

$$
c_a =
t_a(x_a)+ x_a \frac{dt_a}{dx_a}+ \lambda_{CO_2} CO_{2,a}+ \lambda_{acc} Risk_a+ \lambda_{noise} Noise_a
$$

---

# SO (Congestion + CO₂) Assignment Results (Sioux Falls)

## Overview
Three assignment results are compared:

- **UE**: User Equilibrium (private travel time minimization)
- **SO (congestion)**: System optimum internalizing congestion externality
- **SO (congestion + CO₂)**: System optimum internalizing both congestion and CO₂ externalities

The purpose of this analysis is to clarify the **additional effect of incorporating CO₂ externality on top of congestion SO**.



## Assignment Method
- **Route choice model**: Logit-SUE  
- **Path generation**: *k*-shortest paths  
- **Flow update**: Method of Successive Averages (MSA)  
- **Network**: Sioux Falls  
- **Link performance function**: BPR function

$$
t_a(x_a) = t_{0,a}\left(1 + \alpha \left(\frac{x_a}{c_a}\right)^{\beta}\right)
$$



## Cost Definition for System Optimum

### SO with Congestion Externality Only

$$
c_a^{SO} = t_a(x_a) + x_a \frac{dt_a}{dx_a}
$$

### SO with Congestion and CO₂ Externalities

$$
c_a = t_a(x_a) + x_a \frac{dt_a}{dx_a}
+ \lambda_{CO2} \cdot C^{CO2}_a
$$



## CO₂ Cost Estimation (Ex Post Evaluation)

### Speed

$$
v_a = \frac{60 L_a}{t_a}
$$

### Emission Factor

$$
EF(v) = A + Bv + Cv^2 \quad [\mathrm{g/km}]
$$

### CO₂ Cost

$$
C^{CO2}_a
= p_{CO2} \cdot \frac{EF(v_a) L_a}{1000}
\quad [\mathrm{yen/vehicle}]
$$



## Parameter Settings

### CO₂ Emission Factors

| Parameter | Value | Unit |
|---|---:|---:|
| $A$ | 500.17 | g/km |
| $B$ | −7.85 | g/(km·(km/h)) |
| $C$ | 0.0480 | g/(km·(km/h)²) |

### Carbon Price

| Parameter | Value | Unit |
|---|---:|---:|
| $p_{CO2}$ | 15 | yen/kg-CO₂ |

### Value of Time (VOT)

| Parameter | Value | Unit |
|---|---:|---:|
| VOT | 43.74 | yen/min |



## Definition of $\lambda_{CO2}$

$$
\lambda_{CO2} = \frac{1}{\mathrm{VOT}}
$$

Thus, all components of the generalized cost are expressed in time units:

$$
c_a =
t_a(x_a)+ x_a \frac{dt_a}{dx_a}
+ \lambda_{CO2} \cdot C^{CO2}_a
$$



## Comparison of Assignment Results

### Cost Breakdown (Total)

| Cost Component | Total | Unit |
|---|---:|---:|
| Private travel time $\sum x_a t_a$ | 4,622,983 | veh·min |
| Congestion externality $\sum x_a^2 \frac{dt_a}{dx_a}$ | 9,638,484 | veh·min |
| CO₂ externality $\sum \lambda_{CO2} C^{CO2}_a$ | 291,043 | veh·min |

### Overall Comparison

| Indicator | UE | SO (cong) | SO (cong+CO₂) | Δ(SO+CO₂ − UE) | SO+CO₂ / UE | Δ(SO+CO₂ − SO) | SO+CO₂ / SO |
|---|---:|---:|---:|---:|---:|---:|---:|
| Total Flow | 9.10×10⁵ | 9.43×10⁵ | 9.41×10⁵ | +3.06×10⁴ | 1.034 | −2.00×10³ | 0.998 |
| Total Travel Time | 4.63×10⁶ | 4.64×10⁶ | 4.62×10⁶ | −1.15×10⁴ | 0.998 | −1.87×10⁴ | 0.996 |
| Total Marginal Cost | 1.47×10⁷ | 1.43×10⁷ | 1.43×10⁷ | −3.91×10⁵ | 0.973 | −7.33×10⁴ | 0.995 |
| Congestion Externality | 1.00×10⁷ | 9.69×10⁶ | 9.64×10⁶ | −3.80×10⁵ | 0.962 | −5.46×10⁴ | 0.994 |
| **Average Travel Time (min)** | 5.09 | 4.92 | **4.91** | **−0.18** | **0.965** | **−0.01** | **0.998** |
| **Congestion Externality per Vehicle (min)** | 11.01 | 10.28 | **10.25** | **−0.76** | **0.931** | **−0.04** | **0.996** |
| **Total CO₂ Cost (yen)** | 9.55×10⁶ | 9.83×10⁶ | **9.79×10⁶** | +2.46×10⁵ | 1.026 | **−3.30×10⁴** | **0.997** |
| **CO₂ Cost per Vehicle (yen)** | 10.49 | 10.42 | **10.41** | −0.08 | 0.992 | **−0.01** | **0.999** |



## Discussion (Preliminary)
- Internalizing congestion externality substantially improves overall efficiency.
- Adding CO₂ externality further reduces CO₂ costs **while maintaining congestion efficiency**.
- Although the magnitude of CO₂ reduction is small, the effect is consistently beneficial.

Because Sioux Falls is a small and stylized network with limited speed variation,  
the impact of speed-dependent CO₂ externality is expected to be modest.


