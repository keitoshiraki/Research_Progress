# CO₂ Emission Mapping 

## 概要
Toyota の CAN/GPS（約1Hz）データを用いて、リンク単位の CO₂ 排出量を推定し、空間分布として可視化する。
排出効率の悪化が起きていそうなリンクを特定することを目的とする。



## 使用データ

### 1) Toyota CAN/GPS（parquet）
- 対象期間: **2023-09-01 ~ 2023-12-31（0901.parquet〜1231.parquet）**
- ファイル数: **122 files**
- サンプリング: **約1 Hz**
- 主な列
  - `vin_sha256` : 車両ID（匿名化）
  - `gps_timestamp` : 時刻（文字列）
  - `linkid` : リンクID
  - `latitude`, `longitude` : GPS
  - `mmlatitude`, `mmlongitude` : map-matched 座標
  - `tripcount` : 走行トリップID
  - `speed` : 速度
  - `fuelconsumption` : 燃料消費（単位: **L/h**）
  - `stateofcharge` : SOC（EV判定の補助）
  - `fuelgageindication` : 燃料計（EV判定の補助）

### 2) BLink リンク情報
-  `blink_data/BLinkDataPt2_Lv00_HHS_BBX_cleaned.csv`
- 目的: `linkid` に対応するリンク形状を用意するために使用
- 現状のリンク形状は **start/end座標による直線近似**
  - 使用列:
    - `link_id`
    - `start_lng`, `start_lat`
    - `end_lng`, `end_lat`



## データ規模
- 観測点数（全期間）: **2,770,043,364 points**（約1Hz）
- CO₂ 排出量（全期間合計）: **677,195.23 kg**（≒ 677 t）
- CO₂が0でないリンク数（観測あり）: **42,493 links**
- リンク形状データ数（BLink Lv00）: **86,953 links**
- 対象領域（Web Mercator bounds）:
  - (14749547.71, 4054442.01, 14806376.94, 4115412.34)



## CO₂ 計算方法

### 前提
- `fuelconsumption` は **L/h** として扱う
- サンプリングは **約1Hz**のため、1レコードあたりの時間は `Δt = 1 sec` と近似
- 排出係数:
  - ガソリン想定: **EF = 2310 gCO₂/L**

### レコードiでの排出量
- `fuelconsumption_i [L/h]` → `L/sec` に変換し、CO₂に換算

\[
CO2_i [g] = \frac{fuelconsumption_i}{3600} \times EF \times \Delta t
\]

- EVは 0 とする（暫定）:
    - `stateofcharge` が存在し、かつ `fuelgageindication` が欠損/空のものを EV とみなす

### リンク集計
\[
CO2_{link} = \sum_{i \in link} CO2_i
\]
- 出力:
  - `co2_g_sum` : [g/link]
  - `co2_kg_sum` : [kg/link]
  - `n_points` : 観測点数（約1Hz → 滞在時間×通過回数の指標）


## 台数正規化
総CO₂は交通量（通過台数・滞在時間）に強く依存するため、交通量影響を除いた指標として **1台あたり CO₂** を算出する。

- 期間ユニーク台数:
  - `n_vehicles_period = unique(vin_sha256) per link over 09/01–12/31`
- 台数正規化CO₂:
\[
CO2_{per\ vehicle}(kg/vehicle) = \frac{CO2_{link}(kg)}{n\_vehicles\_period}
\]


## 可視化
総CO₂（kg/link）
![00FC1257-4D49-438E-8973-2444B52D675B](https://github.com/user-attachments/assets/4e8f5281-8a97-4bd8-b2e2-f127c5b2b84a)

台数正規化CO₂（kg/vehicle）
![A34FFCF5-2F26-45C8-95FA-19D55E1E182C](https://github.com/user-attachments/assets/07b1dc1e-e838-4d74-a5bd-930729319d01)





## 次にやること

### A. 分析（研究として重要）
1. **総CO₂（kg/link）と台数正規化CO₂（kg/vehicle） の比較**
   - 「交通量が多いからCO₂が大きい」だけでなく、
     「1台あたり排出が大きいリンク」を特定
2. 台数正規化CO₂が高いリンクの特徴分析
   - 生活道路 / 速度変動、勾配など
3. UE（観測状態）と SO（排出効率）乖離の説明
   - 「UEでは選ばれがちだがSOでは避けたいリンク」

## 実行環境
- Python 3.10
- pandas, numpy, geopandas, shapely
- folium, branca
- datashader
