# CO₂ Emission Mapping 

## 概要
Toyota の CAN/GPS（約1Hz）データを用いて、リンク単位の CO₂ 排出量を推定し、空間分布として可視化する。
排出効率の悪化が起きていそうなリンクを特定することを目的とする。



## 使用データ

### 1) Toyota CAN/GPS（parquet）
- 対象期間: **2023-09-01 ~ 2023-12-31（0901.parquet〜1231.parquet）**
- ファイル数: **122 files**
- サンプリング: **約1 Hz**
- 主な列
  - `vin_sha256` : 車両ID（匿名化）
  - `gps_timestamp` : 時刻（文字列）
  - `linkid` : リンクID
  - `latitude`, `longitude` : GPS
  - `mmlatitude`, `mmlongitude` : map-matched 座標
  - `tripcount` : 走行トリップID
  - `speed` : 速度
  - `fuelconsumption` : 燃料消費（単位: **L/h**）
  - `stateofcharge` : SOC（EV判定の補助）
  - `fuelgageindication` : 燃料計（EV判定の補助）

### 2) BLink リンク情報
-  `blink_data/BLinkDataPt2_Lv00_HHS_BBX_cleaned.csv`
- 目的: `linkid` に対応するリンク形状を用意するために使用
- 現状のリンク形状は **start/end座標による直線近似**
  - 使用列:
    - `link_id`
    - `start_lng`, `start_lat`
    - `end_lng`, `end_lat`



## データ規模
- 観測点数（全期間）: **2,770,043,364 points**（約1Hz）
- CO₂ 排出量（全期間合計）: **677,195.23 kg**（≒ 677 t）
- CO₂が0でないリンク数（観測あり）: **42,493 links**
- リンク形状データ数（BLink Lv00）: **86,953 links**
- 対象領域（Web Mercator bounds）:
  - (14749547.71, 4054442.01, 14806376.94, 4115412.34)



## CO₂ 計算方法

### 前提
- `fuelconsumption` は **L/h** として扱う
- サンプリングは **約1Hz**のため、1レコードあたりの時間は `Δt = 1 sec` と近似
- 排出係数:
  - ガソリン想定: **EF = 2310 gCO₂/L**

### レコードiでの排出量
- `fuelconsumption_i [L/h]` → `L/sec` に変換し、CO₂に換算

$$
CO2_i = \frac{fuelconsumption_i}{3600} \times EF \times \Delta t
$$


- EVは 0 とする（暫定）:
    - `stateofcharge` が存在し、かつ `fuelgageindication` が欠損/空のものを EV とみなす

### リンク集計
$$
CO2_{link} = \sum_{i \in link} CO2_i
$$

- 出力:
  - `co2_g_sum` : [g/link]
  - `co2_kg_sum` : [kg/link]
  - `n_points` : 観測点数（約1Hz → 滞在時間×通過回数の指標）


## 台数正規化
総CO₂は交通量（通過台数・滞在時間）に強く依存するため、交通量影響を除いた指標として **1台あたり CO₂** を算出する。

- 期間ユニーク台数:
  - `n_vehicles_period = unique(vin_sha256) per link over 09/01–12/31`
- 台数正規化CO₂:
$$
CO2_{per_vehicle} = \frac{CO2_{link}}{n_{vehicles_period}}
$$






## 可視化
総CO₂（kg/link）
![00FC1257-4D49-438E-8973-2444B52D675B](https://github.com/user-attachments/assets/4e8f5281-8a97-4bd8-b2e2-f127c5b2b84a)

台数正規化CO₂（kg/vehicle）
![A34FFCF5-2F26-45C8-95FA-19D55E1E182C](https://github.com/user-attachments/assets/07b1dc1e-e838-4d74-a5bd-930729319d01)





## 次にやること

1. **総CO₂（kg/link）と台数正規化CO₂（kg/vehicle） の比較**
   - 「交通量が多いからCO₂が大きい」だけでなく、
     「1台あたり排出が大きいリンク」を特定
2. 台数正規化CO₂が高いリンクの特徴分析
   - 生活道路 / 速度変動、勾配など
3. UE（観測状態）と SO（排出効率）乖離の説明
   - 「UEでは選ばれがちだがSOでは避けたいリンク」

## 実行環境
- Python 3.10
- pandas, numpy, geopandas, shapely
- folium, branca
- datashader


# CO₂ Emission Mapping

## Overview
This study estimates link-level CO₂ emissions using Toyota CAN/GPS data (approximately 1 Hz) and visualizes their spatial distribution.  
The objective is to identify road links where emission efficiency is likely to deteriorate from a social perspective.


## Data

### 1) Toyota CAN/GPS (parquet)

- Period: **2023-09-01 to 2023-12-31** (0901.parquet – 1231.parquet)
- Number of files: **122**
- Sampling rate: **approximately 1 Hz**

**Main variables**
- `vin_sha256`: Vehicle ID (anonymized)
- `gps_timestamp`: Timestamp (string)
- `linkid`: Road link ID
- `latitude`, `longitude`: Raw GPS coordinates
- `mmlatitude`, `mmlongitude`: Map-matched coordinates
- `tripcount`: Trip identifier
- `speed`: Vehicle speed
- `fuelconsumption`: Fuel consumption rate (**L/h**)
- `stateofcharge`: State of charge (used for EV identification)
- `fuelgageindication`: Fuel gauge indicator (used for EV identification)


### 2) BLink Road Network Data

- File:  
  `blink_data/BLinkDataPt2_Lv00_HHS_BBX_cleaned.csv`
- Purpose: To construct road link geometries corresponding to `linkid`
- Current representation: **Straight-line approximation using start/end coordinates**

**Used variables**
- `link_id`
- `start_lng`, `start_lat`
- `end_lng`, `end_lat`



## Data Scale

- Total number of observations (entire period):  
  **2,770,043,364 points** (~1 Hz)
- Total CO₂ emissions (entire period):  
  **677,195.23 kg** (≈ 677 tons)
- Number of links with non-zero CO₂ emissions:  
  **42,493**
- Number of links in BLink Lv00:  
  **86,953**
- Spatial extent (Web Mercator bounds):  
  `(14749547.71, 4054442.01, 14806376.94, 4115412.34)`


## CO₂ Estimation Method

### Assumptions
- `fuelconsumption` is treated as **L/h**
- Since the sampling rate is approximately 1 Hz,  
  the time interval per record is approximated as  
  **Δt = 1 second**
- Emission factor:
  - Gasoline vehicle assumption:  
    **EF = 2310 gCO₂/L**



### CO₂ Emission per Record

Fuel consumption is converted from L/h to L/s and then to CO₂ emissions:

$$
CO2_i = \frac{fuelconsumption_i}{3600} \times EF \times \Delta t
$$

- Electric vehicles (EVs) are treated as **0 emissions (temporary rule)**  
  - EV identification (tentative):
    - `stateofcharge` is available, and
    - `fuelgageindication` is missing or empty



### Link-level Aggregation

$$
CO2_{link} = \sum_{i \in link} CO2_i
$$

**Outputs**
- `co2_g_sum`: CO₂ emissions per link [g/link]
- `co2_kg_sum`: CO₂ emissions per link [kg/link]
- `n_points`: Number of observations  
  (≈ 1 Hz → proxy for dwell time × pass frequency)



## Vehicle-normalized CO₂

Since total CO₂ emissions are strongly influenced by traffic volume  
(number of vehicles and dwell time), a vehicle-normalized indicator is introduced to remove traffic volume effects.

- Period-unique vehicle count:
  - `n_vehicles_period` = unique(`vin_sha256`) per link over 09/01–12/31

- Vehicle-normalized CO₂:
$$
CO2_{per\ vehicle} = \frac{CO2_{link}}{n_{vehicles\_period}}
$$




## Visualization

- **Total CO₂ emissions (kg/link)**  
  ![00FC1257-4D49-438E-8973-2444B52D675B](https://github.com/user-attachments/assets/4e8f5281-8a97-4bd8-b2e2-f127c5b2b84a)

- **Vehicle-normalized CO₂ (kg/vehicle)**  
  ![A34FFCF5-2F26-45C8-95FA-19D55E1E182C](https://github.com/user-attachments/assets/07b1dc1e-e838-4d74-a5bd-930729319d01)



## Next Steps


1. Comparison between:
   - Total CO₂ emissions (kg/link), and
   - Vehicle-normalized CO₂ (kg/vehicle)
2. Identification of links where:
   - CO₂ is high **not only due to high traffic volume**, but
   - Per-vehicle emissions are large
3. Characterization of such links:
   - Local streets
   - Speed variability
   - Road gradient, if available
4. Interpretation of the discrepancy between:
   - **UE (User Equilibrium)**: observed traffic state, and
   - **SO (Social Optimum)**: emission efficiency
   - i.e., links that are frequently chosen under UE but undesirable from an SO perspective

---

## Execution Environment

- Python 3.10
- pandas, numpy, geopandas, shapely
- folium, branca
- datashader
